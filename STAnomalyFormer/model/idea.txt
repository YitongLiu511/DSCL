论文中时空分块嵌入层的具体处理过程为：先对原始交通信号数据进行时间因果卷积，增强模型对时间局部上下文的感知能力，使其对短期异常更具鲁棒性，然后沿时间轴将数据划分为非重叠的块，块长度设为P，这样输入的时间步长从T压缩到T/P，大幅降低后续计算的内存占用和复杂度。每个块通过一个可训练的线性投影矩阵（维度为P×d）映射到潜在空间，同时引入可学习的位置编码矩阵（维度为N×N_P×d）来标记块的时空顺序，最终得到嵌入表示，该表示融合了块的特征信息与时空位置信息。

动态全局上下文流包含三个关键部分：  
1.	**时间自注意力块**：对于每个节点的分块嵌入（维度为N_P×d），通过三个不同的权重矩阵分别生成查询矩阵、键矩阵和值矩阵（键矩阵和查询矩阵的维度为d×d_k，值矩阵维度为d×d），然后将查询矩阵与键矩阵的转置进行矩阵乘法，除以键维度的平方根后通过Softmax函数得到注意力权重，再与值矩阵相乘，得到该节点在时间维度上的注意力输出，以此捕捉时间长程依赖。  
   - **窗口式时间掩码**：  
  - 使用滑动窗口计算每个时间分块的**局部变异系数**，识别波动较大的异常观测（如突发尖峰）。  
  - 对高变异系数的观测值用可学习参数替代，保留低变异系数的正常观测值并投影到高维空间，减少异常偏差对模型的误导。  
  - 利用**快速傅里叶变换（FFT）加速计算**，提升掩码效率。  

- **幅度式频率掩码**：  
  - 对时间序列进行傅里叶变换，转换到频率域后计算各频率分量的**幅度**。  
  - 掩码幅度较小的频率分量（通常对应短周期或微弱模式），用可学习参数替代，保留幅度较大的主频率分量（对应显著趋势或季节模式）。  
  - 通过逆傅里叶变换将掩码后的频率信号转回时间域，提取稳定的正常模式特征。  

- **时间掩码自编码器**：  
  - **编码器**：仅输入未掩码的正常观测值，通过时间自注意力块学习时间序列的长程依赖和正常模式。  
  - **解码器**：结合编码器输出的正常模式和掩码位置的可学习参数，重建完整时间序列，确保异常观测仅由正常模式生成。  

- **频率掩码自编码器**：  
  - 采用**仅解码器架构**，直接对频率掩码后的信号进行重建，捕捉频率域的正常模式（如周期性、趋势性）。  
  - 通过时间自注意力块多头自注意力机制建模频率分量间的交互，增强对复杂模式的表示能力。  

2. **对比软聚类**：模型生成K个聚类中心（每个中心维度为T×d），通过计算节点嵌入与所有聚类中心的内积得到分配矩阵（维度为N×K），内积值越大表示节点与对应聚类中心的特征越相似。为了让模型自适应区分不同区域的功能异质性，引入对比异质性损失，该损失通过计算分配矩阵元素与Softmax概率的对数乘积之和的负值来优化，迫使模型将具有相似功能的区域聚到同一类，不同功能的区域区分开，例如住宅区和商业区的流量模式会被明确区分。  
3. **空间自注意力块**：对于每个时间块的节点嵌入（维度为N×d），同样通过三个权重矩阵生成查询、键、值矩阵，计算缩放点积注意力输出，经过归一化层和前馈网络后得到该时间块的节点表示，将所有时间块的表示拼接后，通过平均各时间块的注意力矩阵，得到全局动态时空依赖矩阵，用于描述区域间的空间关联。

静态服务流的处理逻辑为：  
1. **多视图图卷积自适应关系**：针对每个视图的邻接矩阵（如距离、连通性、POI相似性等视图），使用可学习的高斯核函数计算节点间的自适应空间关系。具体来说，对于邻接矩阵中的每个元素，计算其平方的负值除以两倍可学习参数的平方的指数值，再通过缩放操作将每行元素归一化为离散概率分布，得到自适应调整后的邻接矩阵，该矩阵能反映不同视图下节点间关系的敏感程度。  
2. **静态空间依赖融合**：将多个视图的自适应邻接矩阵通过可学习的权重进行加权求和，权重向量满足概率 simplex 条件（即权重之和为1），从而得到融合多视图信息的静态依赖矩阵，该矩阵建模了交通流与区域预期服务水平的静态关联，如距离近的区域、功能相似的区域之间的流量关联。同时，静态流与动态流共享时间自注意力层，提取时间维度的关键特征，再通过图卷积操作融合多视图信息，得到静态流的节点表示。

异常区域检测器的工作流程为：  
1. **门控融合机制**：通过Sigmoid函数计算动态流表示与静态流表示之和的门控向量，门控向量的值在0到1之间，用于控制两种流表示的融合比例。将动态流表示乘以门控向量，静态流表示乘以（1-门控向量），两者相加后通过一个可训练的线性投影矩阵映射回原始数据维度，得到重构的交通信号数据，计算原始数据与重构数据的均方误差作为重构损失，该损失用于确保模型能准确重构正常数据。  
2. **双流对比损失**：为了捕捉动态依赖与静态依赖的不匹配，使用对称KL散度来衡量两者的差异。首先分别计算动态依赖矩阵与静态依赖矩阵的正向和反向KL散度，取平均得到对称KL散度，然后设计两个对比损失函数，分别基于动态流和静态流的依赖矩阵计算损失，通过两者的差值作为双流对比损失，突出异常区域中动态与静态依赖的不一致性。  
#### **3. 时序异常对抗对比训练模块**  
- **对比损失函数**：  
  - 计算时间掩码和频率掩码分支输出的特征表示之间的**对称KL散度**，迫使正常样本在不同视图下的表示一致，异常样本的表示差异扩大。  
  - 正常样本的时间与频率特征高度相似，异常样本因包含掩码消除的异常信息，特征差异显著增大。  

- **对抗训练**：  
  - 在对比损失中引入对抗机制，通过交替优化使模型难以混淆正常与异常样本的特征差异。  
  - 确保模型在最小化正常样本对比损失的同时，最大化异常样本的对比损失，提升检测鲁棒性。  

4. **区域异常分数计算**：将重构损失与双流对比损失按照超参数权重进行线性组合，得到每个节点的异常分数。异常分数越高，表示该节点的实际交通信号与预期服务水平的不匹配程度越大，越可能属于长期交通异常区域。通过设置一个超参数阈值，将异常分数超过阈值的节点判定为异常。
- **异常时间分数计算**：  
  直接使用时间-频率特征的对比差异作为异常分数，分数越高表明与正常模式的差异越大，越可能为异常。
